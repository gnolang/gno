package boards2

import (
	"std"
	"strings"
	"testing"

	"gno.land/p/demo/testutils"
	"gno.land/p/demo/uassert"
	"gno.land/p/moul/txlink"
)

func TestBoardID_String(t *testing.T) {
	input := BoardID(32)

	uassert.Equal(t, "32", input.String())
}

func TestBoardID_Key(t *testing.T) {
	input := BoardID(128)
	want := strings.Repeat("0", 7) + "128"
	uassert.Equal(t, want, input.Key())
}

func TestBoard_GetID(t *testing.T) {
	want := int(92)
	b := new(Board)
	b.id = BoardID(want)
	got := int(b.GetID())

	uassert.Equal(t, got, want)
	uassert.NotEqual(t, got, want*want)
}

func TestBoard_GetURL(t *testing.T) {
	pkgPath := strings.TrimPrefix(std.CurrentRealm().PkgPath(), "gno.land")
	name := "foobar_test_get_url123"
	want := pkgPath + ":" + name

	addr := testutils.TestAddress("creator")
	perms := createDefaultBoardPermissions(addr)
	board := newBoard(1, name, addr, perms)
	got := board.GetURL()
	uassert.Equal(t, want, got)
}

func TestBoard_GetThread(t *testing.T) {
	addr := testutils.TestAddress("creator")
	perms := createDefaultBoardPermissions(addr)
	b := newBoard(1, "test123", addr, perms)

	_, ok := b.GetThread(12345)
	uassert.False(t, ok)

	post := b.AddThread(addr, "foo", "bar")
	_, ok = b.GetThread(post.GetPostID())
	uassert.True(t, ok)
}

func TestBoard_DeleteThread(t *testing.T) {
	addr := testutils.TestAddress("creator")
	perms := createDefaultBoardPermissions(addr)
	b := newBoard(1, "test123", addr, perms)

	post := b.AddThread(addr, "foo", "bar")
	id := post.GetPostID()

	b.DeleteThread(id)

	_, ok := b.GetThread(id)
	uassert.False(t, ok)
}

var boardUrlPrefix = strings.TrimPrefix(std.CurrentRealm().PkgPath(), "gno.land")

func TestBoard_GetURLFromThreadID(t *testing.T) {
	testing.SetRealm(std.NewCodeRealm("gno.land/r/gnoland/boards2/v1"))

	boardName := "test12345"
	addr := testutils.TestAddress("creator")
	perms := createDefaultBoardPermissions(addr)
	b := newBoard(BoardID(11), boardName, addr, perms)
	want := boardUrlPrefix + ":" + boardName + "/10"

	got := b.GetURLFromThreadID(10)
	uassert.Equal(t, want, got)
}

func TestBoard_GetURLFromReplyID(t *testing.T) {
	testing.SetRealm(std.NewCodeRealm("gno.land/r/gnoland/boards2/v1"))

	boardName := "test12345"
	addr := testutils.TestAddress("creator")
	perms := createDefaultBoardPermissions(addr)
	b := newBoard(BoardID(11), boardName, addr, perms)
	want := boardUrlPrefix + ":" + boardName + "/10/20"

	got := b.GetURLFromReplyID(10, 20)
	uassert.Equal(t, want, got)
}

func TestBoard_GetPostFormURL(t *testing.T) {
	bid := BoardID(386)
	addr := testutils.TestAddress("creator")
	perms := createDefaultBoardPermissions(addr)
	b := newBoard(bid, "foo1234", addr, perms)
	expect := txlink.Call("CreateThread", "boardID", bid.String(), "title", "", "body", "")

	got := b.GetPostFormURL()
	uassert.Equal(t, expect, got)
}
