<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CRT SVG Pixelizer (Gno Output)</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
    }
    canvas {
      display: none;
    }
    #preview svg {
      border: 1px solid black;
    }
    textarea {
      width: 100%;
      height: 300px;
      margin-top: 1rem;
      font-family: monospace;
    }
  </style>
</head>
<body>

<h2>CRT SVG Pixelizer (Defs + Gno Export)</h2>
<input type="file" id="imageLoader" accept="image/*"><br>
<label>
  Grid Width:
  <input type="number" id="gridWidth" value="16" min="1">
</label>
<label>
  Grid Height:
  <input type="number" id="gridHeight" value="16" min="1">
</label>
<button id="generateBtn">Generate SVG</button>
<button id="gnoExportBtn">Generate Gno Data</button>

<div id="preview"></div>
<textarea id="gnoOutput" placeholder="Gno struct output will appear here..."></textarea>

<script>
  const imageLoader = document.getElementById('imageLoader');
  const gridWidthInput = document.getElementById('gridWidth');
  const gridHeightInput = document.getElementById('gridHeight');
  const generateBtn = document.getElementById('generateBtn');
  const gnoExportBtn = document.getElementById('gnoExportBtn');
  const preview = document.getElementById('preview');
  const gnoOutput = document.getElementById('gnoOutput');

  let img = new Image();
  let lastImageData = null;

  imageLoader.addEventListener('change', (e) => {
    const reader = new FileReader();
    reader.onload = function(event) {
      img.onload = () => console.log("Image loaded.");
      img.src = event.target.result;
    };
    reader.readAsDataURL(e.target.files[0]);
  });

  function getImageData(gridWidth, gridHeight) {
    const canvas = document.createElement('canvas');
    canvas.width = gridWidth;
    canvas.height = gridHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, gridWidth, gridHeight);
    return ctx.getImageData(0, 0, gridWidth, gridHeight).data;
  }

  generateBtn.addEventListener('click', () => {
    const gridWidth = parseInt(gridWidthInput.value);
    const gridHeight = parseInt(gridHeightInput.value);
    const tileSize = 25;

    const imageData = getImageData(gridWidth, gridHeight);
    lastImageData = imageData;

    const colorMap = new Map();
    const uses = [];

    for (let y = 0; y < gridHeight; y++) {
      for (let x = 0; x < gridWidth; x++) {
        const i = (y * gridWidth + x) * 4;
        const r = imageData[i];
        const g = imageData[i + 1];
        const b = imageData[i + 2];
        const rgb = `rgb(${r},${g},${b})`;

        if (!colorMap.has(rgb)) {
          const className = `c${colorMap.size}`;
          colorMap.set(rgb, className);
        }

        const className = colorMap.get(rgb);
        uses.push(`<use href="#p" x="${x * tileSize}" y="${y * tileSize}" class="${className}"/>`);
      }
    }

    let style = '<style>\n';
    for (const [rgb, className] of colorMap.entries()) {
      style += `  .${className} { fill: ${rgb}; }\n`;
      style += `  .${className}:hover { opacity: 0.8; }\n`;
    }
    style += '</style>\n';

    const svg = `
<svg xmlns="http://www.w3.org/2000/svg" width="${gridWidth * tileSize}" height="${gridHeight * tileSize}">
  <defs>
    <rect id="p" width="${tileSize}" height="${tileSize}" rx="3" ry="3" />
  </defs>
  ${style}
  ${uses.join('\n  ')}
</svg>`;

    preview.innerHTML = svg;
  });
  gnoExportBtn.addEventListener('click', () => {
  const gridWidth = parseInt(gridWidthInput.value);
  const gridHeight = parseInt(gridHeightInput.value);
  const imageData = lastImageData || getImageData(gridWidth, gridHeight);

  let gnoCalls = '';

  for (let y = 0; y < gridHeight; y++) {
    for (let x = 0; x < gridWidth; x++) {
      const i = (y * gridWidth + x) * 4;
      const r = imageData[i];
      const g = imageData[i + 1];
      const b = imageData[i + 2];

      gnoCalls += `image.SetPixel(${x}, ${y}, ${r}, ${g}, ${b})\n`;
    }
  }

  gnoOutput.value = gnoCalls;
});

</script>

</body>
</html>
