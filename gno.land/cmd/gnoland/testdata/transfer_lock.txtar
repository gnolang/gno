## It tests locking token transfers while allowing the payment of gas fees.

## locking transfer applies to regular acocunts
adduser regular1


loadpkg gno.land/r/demo/wugnot
loadpkg gno.land/r/demo/echo

## start a new node.
## The -lock-transfer flag is intended for integration testing purposes
## and is not a valid application flag for gnoland.

gnoland start -lock-transfer

## User test1 is an unrestricted account specified in the genesis state
gnokey maketx send -send "9999999ugnot" -to $USER_ADDR_regular1 -gas-fee 1ugnot -gas-wanted 10000000 -broadcast -chainid=tendermint_test test1

stdout 'OK!'

## Restricted simple token transfer
! gnokey maketx send -send "9999999ugnot" -to g1jg8mtutu9khhfwc4nxmuhcpftf0pajdhfvsqf5 -gas-fee 1ugnot -gas-wanted 10000000 -broadcast -chainid=tendermint_test regular1
stderr 'restricted token transfer error'

## Restricted token transfer by calling a realm deposit function.
! gnokey maketx call -pkgpath gno.land/r/demo/wugnot -func Deposit -gas-fee 1000000ugnot -send "10000ugnot" -gas-wanted 2000000 -broadcast -chainid=tendermint_test regular1
stderr 'restricted token transfer error'


## Restricted token transfer with depositing to a realm package while adding a package.
! gnokey maketx addpkg -pkgdir $WORK -pkgpath gno.land/r/bank -deposit "1000ugnot" -gas-fee 1000000ugnot -gas-wanted 2000000 -broadcast -chainid=tendermint_test regular1
stderr 'restricted token transfer error'

## paying gas fees to add a package is acceptable.
gnokey maketx addpkg -pkgdir $WORK -pkgpath gno.land/r/bank -gas-fee 1000000ugnot -gas-wanted 9500000 -broadcast -chainid=tendermint_test regular1
stdout 'OK!'

## paying gas fees to call a realm function is acceptable.
gnokey maketx call -pkgpath gno.land/r/demo/echo -func Render -args "Hello!" -gas-fee 1000000ugnot -gas-wanted 9500000 -broadcast -chainid=tendermint_test regular1
stdout 'Hello!'

-- bank.gno --
package bank
import (
"std"
)
func Withdraw(denom string, amt int64) string{
  caller := std.GetOrigCaller()
  coin := std.Coins{{denom, amt}}
  banker := std.GetBanker(std.BankerTypeOrigSend)
  pkgaddr := std.GetOrigPkgAddr()
  banker.SendCoins(pkgaddr, caller, coin)
  return "Withdrawed!"
}
