# Test private realm basic functionality

# start a new node
gnoland start

# add a public realm
gnokey maketx addpkg -pkgdir $WORK/publicrealm -pkgpath gno.land/r/foobar/publicrealm -gas-fee 10000000ugnot -gas-wanted 20000000 -broadcast -chainid=tendermint_test $test1_user_addr
stdout OK!

# update the public realm
! gnokey maketx addpkg -pkgdir $WORK/publicrealm -pkgpath gno.land/r/foobar/publicrealm -gas-fee 10000000ugnot -gas-wanted 20000000 -broadcast -chainid=tendermint_test $test1_user_addr
stderr 'package already exists'

# add a private realm
gnokey maketx addpkg -pkgdir $WORK/privaterealm -pkgpath gno.land/r/foobar/privaterealm -gas-fee 10000000ugnot -gas-wanted 20000000 -broadcast -chainid=tendermint_test $test1_user_addr
stdout OK!

# update the same private realm
gnokey maketx addpkg -pkgdir $WORK/privaterealm -pkgpath gno.land/r/foobar/privaterealm -gas-fee 10000000ugnot -gas-wanted 20000000 -broadcast -chainid=tendermint_test $test1_user_addr
stdout OK!

# ensure A is present
gnokey query vm/qeval --data "gno.land/r/foobar/privaterealm.A"
stdout '123'

# update the edited private realm over the original
gnokey maketx addpkg -pkgdir $WORK/privaterealmedited -pkgpath gno.land/r/foobar/privaterealm -gas-fee 10000000ugnot -gas-wanted 20000000 -broadcast -chainid=tendermint_test $test1_user_addr
stdout OK!

# ensure A is deleted
! gnokey query vm/qeval --data "gno.land/r/foobar/privaterealm.A"
stderr 'name A not declared'

# ensure B is present
gnokey query vm/qeval --data "gno.land/r/foobar/privaterealm.B"
stdout '456'

# try to overwrite public realm with private version (should fail - package already exists)
! gnokey maketx addpkg -pkgdir $WORK/publicrealm_private -pkgpath gno.land/r/foobar/publicrealm -gas-fee 10000000ugnot -gas-wanted 20000000 -broadcast -chainid=tendermint_test $test1_user_addr
stderr 'package already exists'

# try to overwrite private realm with public version (should fail)
! gnokey maketx addpkg -pkgdir $WORK/privaterealm_public -pkgpath gno.land/r/foobar/privaterealm -gas-fee 10000000ugnot -gas-wanted 20000000 -broadcast -chainid=tendermint_test $test1_user_addr
stderr 'a private package cannot be overridden by a public package'

-- privaterealm/gnomod.toml --
module = "gno.land/r/foobar/privaterealm"
gno = "0.9"
private = true

-- privaterealm/privaterealm.gno --
package privaterealm
var A = "123"

func Echo(cur realm) string {
	return "hello private world"
}

-- privaterealmedited/gnomod.toml --
module = "gno.land/r/foobar/privaterealm"
gno = "0.9"
private = true

-- privaterealmedited/privaterealm.gno --
package privaterealm
var B = "456"

func Echo(cur realm) string {
	return "hello private edited world"
}

-- privaterealm_public/gnomod.toml --
module = "gno.land/r/foobar/privaterealm"
gno = "0.9"

-- privaterealm_public/privaterealm.gno --
package privaterealm

func Echo(cur realm) string {
	return "hello public world"
}

-- publicrealm/gnomod.toml --
module = "gno.land/r/foobar/publicrealm"
gno = "0.9"

-- publicrealm/publicrealm.gno --
package publicrealm

func Echo(cur realm) string {
	return "hello public world"
}

-- publicrealm_private/gnomod.toml --
module = "gno.land/r/foobar/publicrealm"
gno = "0.9"
private = true

-- publicrealm_private/publicrealm.gno --
package publicrealm

func Echo(cur realm) string {
	return "hello private world trying to overwrite public"
}
