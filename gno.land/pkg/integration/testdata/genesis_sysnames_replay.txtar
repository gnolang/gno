# Test that the actual genesis_txs.jsonl file correctly enables namespace verification
# This test loads the real genesis transactions and verifies r/sys/names is enabled after chain start

# Load all packages required by genesis_txs.jsonl
loadpkg gno.land/r/sys/names
loadpkg gno.land/r/gnoland/users/v1
loadpkg gno.land/r/archive/boards
loadpkg gno.land/r/gnoland/blog

adduser attacker

# Load the actual genesis transactions from genesis_txs.jsonl
# This includes the r/sys/names.Enable() call
loadgenesistxs

# Start with -skip-genesis-sig since genesis txs are signed by production keys
gnoland start -skip-genesis-sig

# Verify that namespace verification is ENABLED after genesis replay
# This proves the Enable() transaction in genesis_txs.jsonl works correctly
gnokey query vm/qeval --data "gno.land/r/sys/names.IsEnabled()"
stdout 'true bool'

# Verify namespace protection is active - attacker cannot deploy to random namespace
! gnokey maketx addpkg -pkgdir $WORK -pkgpath gno.land/r/somename/malicious -gas-fee 1000000ugnot -gas-wanted 10000000 -broadcast -chainid=tendermint_test attacker
stderr 'is not authorized to deploy packages to namespace'

# Attacker CAN deploy to their own address namespace (this should still work)
gnokey maketx addpkg -pkgdir $WORK -pkgpath gno.land/r/$attacker_user_addr/pkg -gas-fee 1000000ugnot -gas-wanted 10000000 -broadcast -chainid=tendermint_test attacker
stdout 'OK!'

-- gnomod.toml --
module = "gno.land/r/test"
gno = "0.9"

-- test.gno --
package test

func Hello() string {
    return "Hello"
}
