## This tests changes  storage_fee_collector and assert that storage_fees are corretly collected 
## by this address when releasing memory on a realm

adduserfrom storage_collector 'post settle extend broken surface clump pulse cook afford forum civil oppose bid raise hello wave deer bar vital vacant evolve junior safe script'
stdout 'g1x5zmkv7gws200q887ahhvztvh833d5wpej3f52'

loadpkg gno.land/r/sys/params
loadpkg gno.land/r/gov/dao/v3/init
loadpkg gno.land/r/gov/dao


## start a new node
gnoland start

## Load member as T1 to be able to vote afterwards
gnokey maketx run -gas-fee 100000ugnot -gas-wanted 95000000 -broadcast -chainid=tendermint_test test1 $WORK/run/load_user.gno

## Submit a proposal to change storage_fee_collector to storage_collector

## pay the fee and submit a proposal to change the fee collector.
gnokey maketx run -gas-fee 100000ugnot -gas-wanted 95000000 -broadcast -chainid=tendermint_test test1 $WORK/run/propose_collector.gno
stdout '0'

## Vote change proposal with unrestricted account test1
gnokey maketx call -pkgpath gno.land/r/gov/dao -func MustVoteOnProposalSimple -gas-fee 1000000ugnot -gas-wanted 10000000 -args 0 -args YES -broadcast -chainid=tendermint_test test1
stdout 'OK!'

## Execute change proposal with unrestricted account test1
gnokey maketx call -pkgpath gno.land/r/gov/dao -func ExecuteProposal -gas-fee 1000000ugnot -gas-wanted 10000000 -args 0 -broadcast -chainid=tendermint_test test1
stdout 'OK!'

## Check storage_collector balance
gnokey query bank/balances/$storage_collector_user_addr
stdout '1000000000ugnot'

gnokey maketx addpkg -pkgdir $WORK/realm -pkgpath gno.land/r/foo -gas-fee 1000000ugnot -gas-wanted 20000000 -max-deposit 502500ugnot -broadcast -chainid=tendermint_test test1
stdout 'EVENTS:     \[{\"bytes_delta\":5025,\"fee_delta\":{\"denom\":\"ugnot\",\"amount\":502500},\"pkg_path\":\"gno.land/r/foo\"}\]'
stdout 'STORAGE DELTA:  5025 bytes'
stdout 'STORAGE FEE:    502500ugnot'
stdout 'TOTAL TX COST:  1502500ugnot'

gnokey query vm/qstorage --data gno.land/r/foo

stdout 'storage: 5025, deposit: 502500'

## Set an object with a smaller size. Exactly 2 bytes are released when we update the realm record from 'hello' to 'foo'.
gnokey maketx call -pkgpath gno.land/r/foo -func NewFoo -args "foo"  -gas-fee 1000000ugnot -gas-wanted 10000000  -broadcast -chainid=tendermint_test test1
stdout OK!
stdout 'EVENTS:     \[{\"bytes_delta\":-2,\"fee_refund\":{\"denom\":\"ugnot\",\"amount\":200},\"pkg_path\":\"gno.land/r/foo\"}\]'
stdout 'STORAGE DELTA:  -2 bytes'
stdout 'STORAGE REFUND: 200ugnot'
stdout 'TOTAL TX COST:  999800ugnot'

gnokey query vm/qstorage --data gno.land/r/foo
stdout 'storage: 5023, deposit: 502300'

# balance from storage_collector should be base storage + 200 ugnot refunded by storage
## Check storage_collector balance
gnokey query bank/balances/$storage_collector_user_addr
stdout '1000000200ugnot'

-- run/load_user.gno --
package main

import (
	i "gno.land/r/gov/dao/v3/init"
	"std"
)

func main() {
	i.InitWithUsers(std.Address("g1jg8mtutu9khhfwc4nxmuhcpftf0pajdhfvsqf5"))
}

-- run/propose_collector.gno --
package main

import (
	"std"
	"gno.land/r/gov/dao"
	"gno.land/r/sys/params"
)

func main() {
	storage_collector := std.Address("g1x5zmkv7gws200q887ahhvztvh833d5wpej3f52")
	pr := params.NewSysParamStringPropRequest("vm", "p", "storage_fee_collector", storage_collector.String())
	pid := dao.MustCreateProposal(cross, pr)
	println(pid.String())
}

-- realm/gnomod.toml --
module = "gno.land/r/foo"

gno = "0.9"

-- realm/storage.gno --
package foo

var record Foo

func init(){
	NewFoo(cross,"hello")
}

type Foo struct{
  name string
}

func NewFoo(cur realm, name string){

  record = Foo{name}
}
func SetName(cur realm, n string){

  record.name = n
}

func GetName()string {
  return record.name
}

func Clear(cur realm){
  record = Foo{}
}


-- package/gnomod.toml --
module = "gno.land/p/foo"

gno = "0.9"

-- package/storage.gno --
package foo

type Foo struct{
  name string
}

var record Foo

func init(){
	NewFoo("hello")
}

func NewFoo(name string){
  record = Foo{name}
}
