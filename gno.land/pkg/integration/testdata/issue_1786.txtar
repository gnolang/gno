# XXX: NEED UPDATE: cannot send transfer to self

# Test for https://github.com/gnolang/gno/issues/1786
# Tests that cross-realm Withdraw correctly uses CurrentRealm (not the caller's)
# for BankerTypeRealmSend, so wugnot only sends from its own balance.

loadpkg gno.land/r/gnoland/wugnot

gnoland start

# add proxy contract
gnokey maketx addpkg -pkgdir $WORK -pkgpath gno.land/r/demo/proxywugnot -gas-fee 1000000ugnot -gas-wanted 16000000 -broadcast -chainid=tendermint_test test1
stdout OK!

# user deposits directly into wugnot (origin call)
gnokey maketx call -pkgpath gno.land/r/gnoland/wugnot --send "10000ugnot" -func Deposit -gas-fee 1000000ugnot -gas-wanted 40000000 -broadcast -chainid=tendermint_test test1
stdout OK!

# check user's wugnot balance
gnokey query vm/qeval --data "gno.land/r/gnoland/wugnot.BalanceOf(\"g1jg8mtutu9khhfwc4nxmuhcpftf0pajdhfvsqf5\")"
stdout '10000 int64'

# approve wugnot to `proxywugnot â‰ˆ g1fndyg0we60rdfchyy5dwxzkfmhl5u34j932rg3`
gnokey maketx call -pkgpath gno.land/r/gnoland/wugnot -func Approve -args "g1fndyg0we60rdfchyy5dwxzkfmhl5u34j932rg3" -args 10000 -gas-fee 1000000ugnot -gas-wanted 40000000 -broadcast -chainid=tendermint_test test1
stdout OK!

# unwrap 500 wugnot through proxy (tests cross-realm BankerTypeRealmSend permission)
gnokey maketx call -pkgpath gno.land/r/demo/proxywugnot -func ProxyUnwrap -args 500 -gas-fee 1000000ugnot -gas-wanted 40000000 -broadcast -chainid=tendermint_test test1

# XXX without patching anything it will panic
# panic msg: insufficient coins error
# XXX with pathcing only wugnot.gnot it will panic
# panic msg: RealmSendBanker can only send from the realm package address "g1fndyg0we60rdfchyy5dwxzkfmhl5u34j932rg3", but got "g1pf6dv9fjk3rn0m4jjcne306ga4he3mzmupfjl6"

# check user's wugnot balance
gnokey query vm/qeval --data "gno.land/r/gnoland/wugnot.BalanceOf(\"g1jg8mtutu9khhfwc4nxmuhcpftf0pajdhfvsqf5\")"
stdout '9500 int64'

# render
gnokey query vm/qrender --data "gno.land/r/gnoland/wugnot:invalid"
stdout 'data: 404'

-- gnomod.toml --
module = "gno.land/r/demo/proxywugnot"
gno = "0.9"

-- realm.gno --
package proxywugnot

import (
	"chain"
	"chain/banker"
	"chain/runtime"

	"gno.land/r/gnoland/wugnot"
)

func ProxyUnwrap(cur realm, wugnotAmount int64) {
	if wugnotAmount == 0 {
		return
	}

	// SEND WUGNOT: USER -> PROXY_WUGNOT
	wugnot.TransferFrom(cross, runtime.OriginCaller(), runtime.CurrentRealm().Address(), wugnotAmount)

	// UNWRAP IT
	wugnot.Withdraw(cross, wugnotAmount)

	// SEND GNOT: PROXY_WUGNOT -> USER
	banker_ := banker.NewBanker(banker.BankerTypeRealmSend)
	banker_.SendCoins(runtime.CurrentRealm().Address(), runtime.OriginCaller(), chain.Coins{{"ugnot", int64(wugnotAmount)}})
}
