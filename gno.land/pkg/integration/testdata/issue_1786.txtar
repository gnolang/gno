# Test for https://github.com/gnolang/gno/issues/1786
# Deposit and Withdraw must be called directly (origin calls only).
# Cross-realm calls are blocked by AssertOriginCall() to prevent MITM attacks.

loadpkg gno.land/r/gnoland/wugnot

gnoland start

# user deposits directly into wugnot (origin call)
gnokey maketx call -pkgpath gno.land/r/gnoland/wugnot --send "10000ugnot" -func Deposit -gas-fee 1000000ugnot -gas-wanted 40000000 -broadcast -chainid=tendermint_test test1
stdout OK!

# check user's wugnot balance
gnokey query vm/qeval --data "gno.land/r/gnoland/wugnot.BalanceOf(\"g1jg8mtutu9khhfwc4nxmuhcpftf0pajdhfvsqf5\")"
stdout '10000 int64'

# user withdraws 500 wugnot directly (origin call)
gnokey maketx call -pkgpath gno.land/r/gnoland/wugnot -func Withdraw -args 500 -gas-fee 1000000ugnot -gas-wanted 40000000 -broadcast -chainid=tendermint_test test1
stdout OK!

# check user's wugnot balance after withdraw
gnokey query vm/qeval --data "gno.land/r/gnoland/wugnot.BalanceOf(\"g1jg8mtutu9khhfwc4nxmuhcpftf0pajdhfvsqf5\")"
stdout '9500 int64'

# render
gnokey query vm/qrender --data "gno.land/r/gnoland/wugnot:invalid"
stdout 'data: 404'
