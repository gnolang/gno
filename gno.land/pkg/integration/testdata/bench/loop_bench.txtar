# Test benchops profiling with repeated function calls
#
# This test profiles the same function with different arguments to verify
# that benchops correctly captures different operation counts.
#
# - profile_10a.json and profile_10b.json: same function, same arg (10 iterations)
# - profile_100.json: same function, different arg (100 iterations)
#
# Profile outputs are automatically written to this file when
# running with UPDATE_SCRIPTS=true

gnoland start

# Deploy the loop counter realm
gnokey maketx addpkg -pkgdir $WORK/loop -pkgpath gno.land/r/$test1_user_addr/loop -gas-fee 1000000ugnot -gas-wanted 2000000 -broadcast -chainid tendermint_test test1

# Profile first call with 10 iterations
bench start profile_10a.json
gnokey maketx call -pkgpath gno.land/r/$test1_user_addr/loop -func Loop -args 10 -gas-fee 1000000ugnot -gas-wanted 2000000 -broadcast -chainid tendermint_test test1
bench stop

# Profile second call with 10 iterations (should match profile_10a)
bench start profile_10b.json
gnokey maketx call -pkgpath gno.land/r/$test1_user_addr/loop -func Loop -args 10 -gas-fee 1000000ugnot -gas-wanted 2000000 -broadcast -chainid tendermint_test test1
bench stop

# Profile call with 100 iterations (should have ~10x more ops)
bench start profile_100.json
gnokey maketx call -pkgpath gno.land/r/$test1_user_addr/loop -func Loop -args 100 -gas-fee 1000000ugnot -gas-wanted 2000000 -broadcast -chainid tendermint_test test1
bench stop

# Verify that identical calls produce identical deterministic profiles
# (Store is excluded from comparison since it varies between runs)
cmpbench profile_10a.json profile_10b.json opcodes,hotspots

# Verify that different iteration counts produce different profiles
! cmpbench profile_10a.json profile_100.json opcodes,hotspots

-- loop/gnomod.toml --
module = "loop"
gno = "0.9"

-- loop/loop.gno --
package loop

var total int

// Loop increments a counter n times and returns the total.
func Loop(cur realm, n int) int {
	for i := 0; i < n; i++ {
		total++
	}
	return total
}

// GetTotal returns the current total.
func GetTotal() int {
	return total
}
-- profile_10a.json --
Opcodes:
  OpBody: count=4 gas=43
  OpCall: count=2 gas=256
  OpDefine: count=2 gas=111
  OpEnterCrossing: count=2 gas=100
  OpEval: count=86 gas=29
  OpExec: count=2 gas=25
  OpForLoop: count=42 gas=27
  OpHalt: count=14 gas=1
  OpInc: count=40 gas=76
  OpLss: count=22 gas=13
  OpPopBlock: count=8 gas=3
  OpPrecall: count=2 gas=207
  OpReturn: count=2 gas=38
  OpSelector: count=2 gas=32
  OpVoid: count=236 gas=1
HotSpots:
  loop.gno:7 -: count=26 gas=1850
  loop.gno:8 -: count=20 gas=1520
-- profile_10b.json --
Opcodes:
  OpBody: count=4 gas=43
  OpCall: count=2 gas=256
  OpDefine: count=2 gas=111
  OpEnterCrossing: count=2 gas=100
  OpEval: count=86 gas=29
  OpExec: count=2 gas=25
  OpForLoop: count=42 gas=27
  OpHalt: count=14 gas=1
  OpInc: count=40 gas=76
  OpLss: count=22 gas=13
  OpPopBlock: count=8 gas=3
  OpPrecall: count=2 gas=207
  OpReturn: count=2 gas=38
  OpSelector: count=2 gas=32
  OpVoid: count=236 gas=1
HotSpots:
  loop.gno:7 -: count=26 gas=1850
  loop.gno:8 -: count=20 gas=1520
-- profile_100.json --
Opcodes:
  OpBody: count=4 gas=43
  OpCall: count=2 gas=256
  OpDefine: count=2 gas=111
  OpEnterCrossing: count=2 gas=100
  OpEval: count=626 gas=29
  OpExec: count=2 gas=25
  OpForLoop: count=402 gas=27
  OpHalt: count=14 gas=1
  OpInc: count=400 gas=76
  OpLss: count=202 gas=13
  OpPopBlock: count=8 gas=3
  OpPrecall: count=2 gas=207
  OpReturn: count=2 gas=38
  OpSelector: count=2 gas=32
  OpVoid: count=1676 gas=1
HotSpots:
  loop.gno:7 -: count=206 gas=15530
  loop.gno:8 -: count=200 gas=15200
