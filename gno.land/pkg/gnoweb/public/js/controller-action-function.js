import{BaseController as p,debounce as g,escapeShellSpecialChars as m}from"./controller.js";var d=class extends p{sendValue=null;get _paramInputs(){return this._paramInputsCache||(this._paramInputsCache=this.getTargets("param-input")),this._paramInputsCache}connect(){this.initializeDOM({"send-code":this.getTargets("send-code")}),this._funcName=this.getValue("name")||null,this._pkgPath=this.getValue("pkgpath")||null,this._initializeArgs(),this._listenForEvents(),this._updateQEvalResult(),this._dispatchParamsChanged()}_listenForEvents(){this.on("mode:changed",t=>{let e=t.detail.mode;this._updateAllFunctionsMode(e)}),this.on("address:changed",t=>{let e=t.detail.address;this._updateAllFunctionsAddress(e)})}_updateAllFunctionsMode(t){this.getTargets("mode").forEach(e=>{let a=this.getValue("mode",e)===t;e.classList.toggle("u-inline",a),e.classList.toggle("u-hidden",!a),e.dataset.copyTarget=a&&this._funcName?`action-function-${this._funcName}`:""})}_updateAllFunctionsAddress(t){this.getTargets("address").forEach(e=>{e.textContent=t.trim()||"ADDRESS"})}_sanitizeArgsInput(t){let s=this.getValue("param",t)||"",e=t.value.trim();return s||console.warn("sanitizeArgsInput: param is missing in arg input dataset."),{paramName:s,paramValue:e}}_getParamCurrentValue(t){let s=this._paramInputs.filter(a=>this.getValue("param",a)===t);if(!s.length)return"";let e=s[0];return e.type==="checkbox"?s.filter(a=>a.checked||a.defaultChecked).map(a=>a.value.trim()).join(","):e.type==="radio"?s.find(n=>n.checked||n.defaultChecked)?.value.trim()||"":e.value.trim()}_initializeArgs(){let t=new Set;this._paramInputs.forEach(s=>{let e=this.getValue("param",s)||"";if(!e||t.has(e))return;let a=this._getParamCurrentValue(e);a&&this._updateArgInDOM(e,a),t.add(e)})}_debouncedUpdateAllArgs=g((t,s)=>{t&&(this._updateArgInDOM(t,s),this._updateQEvalResult(),this._dispatchParamsChanged())},50);_dispatchParamsChanged(){if(!this._funcName||!this._pkgPath)return;let t={},s=new Set;this._paramInputs.forEach(e=>{let a=this.getValue("param",e)||"";!a||s.has(a)||(t[a]=this._getParamCurrentValue(a),s.add(a))}),this.dispatch("params:changed",{pkgPath:this._pkgPath,funcName:this._funcName,params:t,send:this.sendValue||void 0})}_updateArgInDOM(t,s){let e=m(s);this.getTargets("arg").filter(o=>this.getValue("arg",o)===t).forEach(o=>{o.textContent=e||""});let a=this.getTarget("function-execute"),n=this.getTarget("function-anchor");if(!a&&!n)return;let c=a?.getAttribute("action")||n?.getAttribute("data-copy-text-value");if(!c)return;let r=c.split("&"),i=encodeURIComponent(s),u=r.findIndex((o,h)=>h>0&&o.startsWith(`${t}=`));u!==-1?r[u]=`${t}=${i}`:r.push(`${t}=${i}`);let l=r.join("&");a?.setAttribute("action",l),n?.setAttribute("data-copy-text-value",l)}async _updateQEvalResult(){let t=this.getTarget("qeval-result"),s=this.getTarget("remote");if(!(t&&s))return;let e=this.getTargets("arg");if(!e.every(i=>i.textContent!=="")){t.textContent="(enter param values)",t.classList.remove("u-color-danger");return}let n=e.map(i=>i.textContent.replace(/\\(.)/g,"$1")).join(","),c=`${this._pkgPath}.${this._funcName}(${n})`,r=await this._fetchQEval(s.textContent||"",c);t.textContent=r,t.classList.toggle("u-color-danger",r.startsWith("Error:"))}async _fetchQEval(t,s){try{let e=`${t}/abci_query?path=vm%2fqeval&data=${btoa(s)}`,a=await fetch(e);if(!a.ok)return"";let n=(await a.json()).result.response.ResponseBase;return n.Data?atob(n.Data):`Error: ${n.Error.value}`}catch{return""}}updateAllArgs(t){let s=t.target,e=this.getValue("param",s);if(!e)return;let a=this._getParamCurrentValue(e);this._debouncedUpdateAllArgs(e,a)}updateAllFunctionsSend(t){let s=t.params?.send||!1;this.sendValue=s?this.getValue("send"):null,this.getDOMArray("send-code").forEach(e=>{e.textContent=this.sendValue||""}),this._dispatchParamsChanged()}};export{d as ActionFunctionController};
