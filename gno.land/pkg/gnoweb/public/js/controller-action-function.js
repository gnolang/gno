import{BaseController as p,debounce as g,escapeShellSpecialChars as m}from"./controller.js";var d=class extends p{sendValue=null;get _paramInputs(){return this._paramInputsCache||(this._paramInputsCache=this.getTargets("param-input")),this._paramInputsCache}connect(){this.initializeDOM({"send-code":this.getTargets("send-code")}),this._funcName=this.getValue("name")||null,this._pkgPath=this.getValue("pkgpath")||null,this._initializeArgs(),this._listenForEvents(),this._updateQEvalResult(),this._dispatchParamsChanged()}_listenForEvents(){this.on("mode:changed",e=>{let t=e.detail.mode;this._updateAllFunctionsMode(t)}),this.on("address:changed",e=>{let t=e.detail.address;this._updateAllFunctionsAddress(t)})}_updateAllFunctionsMode(e){this.getTargets("mode").forEach(t=>{let s=this.getValue("mode",t)===e;t.classList.toggle("u-inline",s),t.classList.toggle("u-hidden",!s),t.dataset.copyTarget=s&&this._funcName?`action-function-${this._funcName}`:""})}_updateAllFunctionsAddress(e){this.getTargets("address").forEach(t=>{t.textContent=e.trim()||"ADDRESS"})}_getParamCurrentValue(e){let a=this._paramInputs.filter(s=>this.getValue("param",s)===e);if(!a.length)return"";let t=a[0];return t.type==="checkbox"?a.filter(s=>s.checked).map(s=>s.value.trim()).join(","):t.type==="radio"?a.find(n=>n.checked)?.value.trim()||"":t.value.trim()}_initializeArgs(){let e=new Set;this._params={},this._paramInputs.forEach(a=>{let t=this.getValue("param",a)||"";if(!t||e.has(t))return;let s=this._getParamCurrentValue(t);this._params[t]=s,s&&this._updateArgInDOM(t,s),e.add(t)})}_debouncedUpdateAllArgs=g((e,a)=>{e&&(this._updateArgInDOM(e,a),this._updateQEvalResult(),this._dispatchParamsChanged())},50);_dispatchParamsChanged(){!this._funcName||!this._pkgPath||this.dispatch("params:changed",{pkgPath:this._pkgPath,funcName:this._funcName,params:{...this._params},send:this.sendValue||void 0})}_updateArgInDOM(e,a){let t=m(a);this.getTargets("arg").filter(o=>this.getValue("arg",o)===e).forEach(o=>{o.textContent=t||""});let s=this.getTarget("function-execute"),n=this.getTarget("function-anchor");if(!s&&!n)return;let c=s?.getAttribute("action")||n?.getAttribute("data-copy-text-value");if(!c)return;let r=c.split("&"),i=encodeURIComponent(a),u=r.findIndex((o,h)=>h>0&&o.startsWith(`${e}=`));u!==-1?r[u]=`${e}=${i}`:r.push(`${e}=${i}`);let l=r.join("&");s?.setAttribute("action",l),n?.setAttribute("data-copy-text-value",l)}async _updateQEvalResult(){let e=this.getTarget("qeval-result"),a=this.getTarget("remote");if(!(e&&a))return;let t=this.getTargets("arg");if(!t.every(i=>i.textContent!=="")){e.textContent="(enter param values)",e.classList.remove("u-color-danger");return}let n=t.map(i=>i.textContent.replace(/\\(.)/g,"$1")).join(","),c=`${this._pkgPath}.${this._funcName}(${n})`,r=await this._fetchQEval(a.textContent||"",c);e.textContent=r,e.classList.toggle("u-color-danger",r.startsWith("Error:"))}async _fetchQEval(e,a){try{let t=`${e}/abci_query?path=vm%2fqeval&data=${btoa(a)}`,s=await fetch(t);if(!s.ok)return"";let n=(await s.json()).result.response.ResponseBase;return n.Data?atob(n.Data):`Error: ${n.Error.value}`}catch{return""}}updateAllArgs(e){let a=e.target,t=this.getValue("param",a);if(!t)return;let s=this._getParamCurrentValue(t);this._params[t]=s,this._debouncedUpdateAllArgs(t,s)}updateAllFunctionsSend(e){let a=e.params?.send||!1;this.sendValue=a?this.getValue("send"):null,this.getDOMArray("send-code").forEach(t=>{t.textContent=this.sendValue||""}),this._dispatchParamsChanged()}};export{d as ActionFunctionController};
