import{BaseController as l,debounce as c,escapeShellSpecialChars as u}from"./controller.js";var o=class extends l{sendValue=null;connect(){this.initializeDOM({"send-code":this.getTargets("send-code")}),this._funcName=this.getValue("name")||null,this._pkgPath=this.getValue("pkgpath")||null,this._initializeArgs(),this._listenForEvents(),this._updateQEvalResult()}_listenForEvents(){this.on("mode:changed",t=>{let e=t.detail.mode;console.log("mode:changed",e),this._updateAllFunctionsMode(e)}),this.on("address:changed",t=>{let e=t.detail.address;this._updateAllFunctionsAddress(e)})}_updateAllFunctionsMode(t){this.getTargets("mode").forEach(e=>{console.log("modeElement in function",e);let n=this.getValue("mode",e)===t;e.classList.toggle("u-inline",n),e.classList.toggle("u-hidden",!n),e.dataset.copyTarget=n&&this._funcName?`action-function-${this._funcName}`:""})}_updateAllFunctionsAddress(t){this.getTargets("address").forEach(e=>{e.textContent=t.trim()||"ADDRESS"})}_sanitizeArgsInput(t){let s=this.getValue("param",t)||"",e=t.value.trim();return s||console.warn("sanitizeArgsInput: param is missing in arg input dataset."),{paramName:s,paramValue:e}}_initializeArgs(){this.getTargets("param-input").forEach(t=>{let{paramName:s,paramValue:e}=this._sanitizeArgsInput(t);s&&this._pushArgsInDOM(s,e)})}_debouncedUpdateAllArgs=c((t,s)=>{t&&this._pushArgsInDOM(t,s)},50);_pushArgsInDOM(t,s){let e=u(s);this.getTargets("arg").filter(i=>this.getValue("arg",i)===t).forEach(i=>{i.textContent=e||""});let n=this.getTarget("function-link");if(n){if(!n.getAttribute("href")){console.warn("No href attribute found for function link");return}let a=new URL(n.href,window.location.origin);a.searchParams.set(t,s),n.href=a.toString()}this._updateQEvalResult()}_updateQEvalResult(){let t=this.getTarget("qeval-result"),s=this.getTarget("remote");if(!(t&&s))return;let e="",n=!0;for(let a of this.getTargets("arg")){if(a.textContent===""){n=!1;break}e!==""&&(e+=","),e+=a.textContent.replace(/\\(.)/g,"$1")}if(!n){t.textContent="(enter param values)";return}let i=`${this._pkgPath}.${this._funcName}(${e})`;fetch(`http://${s.textContent}/abci_query?path=vm%2fqeval&data=${btoa(i)}`).then(async a=>{if(a.ok){let r=(await a.json()).result.response.ResponseBase;r.Data?t.textContent=atob(r.Data):t.textContent=`Error: ${r.Error.value}`}else t.textContent=""}).catch(a=>{t.textContent=""})}updateAllArgs(t){let s=t.target,{paramName:e,paramValue:n}=this._sanitizeArgsInput(s);e&&this._debouncedUpdateAllArgs(e,n)}updateAllFunctionsSend(t){let s=t.params?.send||!1;this.getDOMArray("send-code").forEach(e=>{e.textContent=s?this.getValue("send"):""})}};export{o as ActionFunctionController};
