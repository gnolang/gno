import{BaseController as c,debounce as u,escapeShellSpecialChars as d}from"./controller.js";var l=class extends c{sendValue=null;connect(){this.initializeDOM({"send-code":this.getTargets("send-code")}),this._funcName=this.getValue("name")||null,this._pkgPath=this.getValue("pkgpath")||null,this._initializeArgs(),this._listenForEvents(),this._updateQEvalResult()}_listenForEvents(){this.on("mode:changed",t=>{let e=t.detail.mode;this._updateAllFunctionsMode(e)}),this.on("address:changed",t=>{let e=t.detail.address;this._updateAllFunctionsAddress(e)})}_updateAllFunctionsMode(t){this.getTargets("mode").forEach(e=>{let s=this.getValue("mode",e)===t;e.classList.toggle("u-inline",s),e.classList.toggle("u-hidden",!s),e.dataset.copyTarget=s&&this._funcName?`action-function-${this._funcName}`:""})}_updateAllFunctionsAddress(t){this.getTargets("address").forEach(e=>{e.textContent=t.trim()||"ADDRESS"})}_sanitizeArgsInput(t){let a=this.getValue("param",t)||"",e=t.value.trim();return a||console.warn("sanitizeArgsInput: param is missing in arg input dataset."),{paramName:a,paramValue:e}}_getParamCurrentValue(t){let a=this.getTargets("param-input").filter(s=>this.getValue("param",s)===t).map(s=>s);if(!a.length)return"";let e=a[0];return e.type==="checkbox"?a.filter(s=>s.checked||s.defaultChecked).map(s=>s.value.trim()).join(","):e.type==="radio"?a.find(n=>n.checked||n.defaultChecked)?.value.trim()||"":e.value.trim()}_initializeArgs(){let t=new Set;this.getTargets("param-input").forEach(a=>{let e=a,s=this.getValue("param",e)||"";if(!s||t.has(s))return;let n=this._getParamCurrentValue(s);n&&this._updateArgInDOM(s,n),t.add(s)})}_debouncedUpdateAllArgs=u((t,a)=>{t&&(this._updateArgInDOM(t,a),this._updateQEvalResult())},50);_updateArgInDOM(t,a){let e=d(a);this.getTargets("arg").filter(n=>this.getValue("arg",n)===t).forEach(n=>{n.textContent=e||""});let s=[...this.getTargets("function-execute"),...this.getTargets("function-anchor")];s.length>0&&s.forEach(n=>{let o=n.hasAttribute("href")?"href":"data-copy-text-value",i=n.getAttribute(o);if(!i){console.warn(`No href or data-copy-text-value attribute found for the function link: ${n}.`);return}let r=new URL(i,window.location.origin);r.searchParams.set(t,a),n.setAttribute(o,r.toString()||"")})}async _updateQEvalResult(){let t=this.getTarget("qeval-result"),a=this.getTarget("remote");if(!(t&&a))return;let e=this.getTargets("arg");if(!e.every(r=>r.textContent!=="")){t.textContent="(enter param values)",t.classList.remove("u-color-danger");return}let n=e.map(r=>r.textContent.replace(/\\(.)/g,"$1")).join(","),o=`${this._pkgPath}.${this._funcName}(${n})`,i=await this._fetchQEval(a.textContent||"",o);t.textContent=i,t.classList.toggle("u-color-danger",i.startsWith("Error:"))}async _fetchQEval(t,a){try{let e=`http://${t}/abci_query?path=vm%2fqeval&data=${btoa(a)}`,s=await fetch(e);if(!s.ok)return"";let n=(await s.json()).result.response.ResponseBase;return n.Data?atob(n.Data):`Error: ${n.Error.value}`}catch{return""}}updateAllArgs(t){let a=t.target,e=this.getValue("param",a);if(!e)return;let s=this._getParamCurrentValue(e);this._debouncedUpdateAllArgs(e,s)}updateAllFunctionsSend(t){let a=t.params?.send||!1;this.getDOMArray("send-code").forEach(e=>{e.textContent=a?this.getValue("send"):""})}};export{l as ActionFunctionController};
